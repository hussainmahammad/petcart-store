---
# ClusterRole and ClusterRoleBinding to allow ADOT to read metrics from kubelet
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: adot-container-insights-role
rules:
  - apiGroups: [""]
    resources: ["nodes", "nodes/stats", "nodes/proxy", "pods"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: adot-container-insights-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: adot-container-insights-role
subjects:
  - kind: ServiceAccount
    name: adot-collector
    namespace: fargate-container-insights
---
# ConfigMap with ADOT configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: adot-collector-conf
  namespace: fargate-container-insights
data:
  config.yaml: |
    receivers:
      prometheus:
        config:
          global:
            scrape_interval: 60s
            scrape_timeout: 10s
          scrape_configs:
            - job_name: 'cadvisor'
              scrape_interval: 60s
              metrics_path: /metrics/cadvisor
              scheme: https
              tls_config:
                ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                insecure_skip_verify: true
              authorization:
                credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              kubernetes_sd_configs:
                - role: node
              relabel_configs:
                - source_labels: [__meta_kubernetes_node_label_beta_kubernetes_io_os]
                  regex: linux
                  action: keep
                - target_label: __address__
                  replacement: kubernetes.default.svc:443
                - source_labels: [__meta_kubernetes_node_name]
                  target_label: node
                  replacement: $1
    processors:
      batch:
        send_batch_size: 10000
        timeout: 10s
      resourcedetection:
        detectors: ['env', 'eks']
        override: false
      filter:
        metrics:
          exclude:
            match_type: regexp
            metric_names:
              - ^container_memory_rss$
              - ^container_memory_cache$
              - ^container_memory_failcnt$
              - ^container_cpu_cfs_periods$
              - ^container_cpu_cfs_throttled_periods$
    exporters:
      awscloudwatch:
        namespace: ContainerInsights
        region: us-east-1
        log_group_name: "/aws/containerinsights/petcart-eks/performance"
        log_stream_name: "{TaskId}"
        dimension_rollup_option: NoDimensionRollup
        resource_to_telemetry_conversion:
          enabled: true
    service:
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: [filter, batch, resourcedetection]
          exporters: [awscloudwatch]
---
# StatefulSet for ADOT Collector
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: adot-collector
  namespace: fargate-container-insights
spec:
  serviceName: adot-collector
  replicas: 1
  selector:
    matchLabels:
      app: adot-collector
  template:
    metadata:
      labels:
        app: adot-collector
    spec:
      serviceAccountName: adot-collector
      containers:
        - name: adot-collector
          image: public.ecr.aws/aws-observability/aws-otel-collector:latest
          args:
            - --config=/conf/config.yaml
            - --feature-gates=-service.pipelines.metrics.receiver.prometheus.execreceiver
          volumeMounts:
            - name: config-volume
              mountPath: /conf
      volumes:
        - name: config-volume
          configMap:
            name: adot-collector-conf
