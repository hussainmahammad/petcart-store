pipeline {
  agent { label 'agent-b' }

  environment {
    AWS_REGION   = "us-east-1"
    CLUSTER_NAME = "petcart-eks"
    NAMESPACE    = "petcart"
  }

  parameters {
    choice(
      name: 'DESTROY_TARGET',
      choices: ['ec2', 'eks-fargate', 'eks-ec2'],
      description: 'Choose what to destroy'
    )
  }

  stages {

    stage('Checkout Repo') {
      steps { checkout scm }
    }



    /* ==================================================
       EKS – FARGATE DESTROY (FULL WIPEOUT)
       ================================================== */
    stage('Destroy EKS (Fargate)') {
      when { expression { params.DESTROY_TARGET == 'eks-fargate' } }
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'account-c-aws']]) {
          sh '''
            set +e
            echo "Starting FULL Fargate destroy..."

            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

            aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME} || true

            # --------------------
            # App resources
            # --------------------
            kubectl delete ingress petcart-ingress -n ${NAMESPACE} --ignore-not-found
            sleep 60
            kubectl delete svc petcart-service -n ${NAMESPACE} --ignore-not-found
            kubectl delete deployment petcart-deployment -n ${NAMESPACE} --ignore-not-found
            kubectl delete ns ${NAMESPACE} --ignore-not-found

            kubectl delete configmap aws-logging -n aws-observability --ignore-not-found
            kubectl delete ns aws-observability --ignore-not-found

            # --------------------
            # ALB Controller
            # --------------------
            helm uninstall aws-load-balancer-controller -n kube-system || true

            eksctl delete iamserviceaccount \
              --cluster ${CLUSTER_NAME} \
              --region ${AWS_REGION} \
              --namespace kube-system \
              --name aws-load-balancer-controller || true

            # --------------------
            # Delete EKS cluster
            # --------------------
            eksctl delete cluster --name ${CLUSTER_NAME} --region ${AWS_REGION} || true

            # --------------------
            # Cleanup IAM policy (created by deploy)
            # --------------------
            aws iam delete-policy \
              --policy-arn arn:aws:iam::$ACCOUNT_ID:policy/AWSLoadBalancerControllerIAMPolicyEC2 || true

            echo "EKS Fargate FULL destroy completed."
          '''
        }
      }
    }

    /* ==================================================
       EKS – EC2 NODE GROUP DESTROY (FULL WIPEOUT)
       ================================================== */
    stage('Destroy EKS (EC2 Node Group)') {
      when { expression { params.DESTROY_TARGET == 'eks-ec2' } }
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'account-c-aws']]) {
          sh '''
            set +e
            echo "Starting FULL EC2 EKS destroy..."

            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

            aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME} || true

            # --------------------
            # App resources
            # --------------------
            kubectl delete ingress petcart-ingress -n ${NAMESPACE} --ignore-not-found
            sleep 60
            kubectl delete svc petcart-service -n ${NAMESPACE} --ignore-not-found
            kubectl delete deployment petcart-deployment -n ${NAMESPACE} --ignore-not-found
            kubectl delete ns ${NAMESPACE} --ignore-not-found

            # --------------------
            # ALB Controller
            # --------------------
            helm uninstall aws-load-balancer-controller -n kube-system || true

            eksctl delete iamserviceaccount \
              --cluster ${CLUSTER_NAME} \
              --region ${AWS_REGION} \
              --namespace kube-system \
              --name aws-load-balancer-controller || true

            # --------------------
            # CloudWatch Observability
            # --------------------
            aws eks delete-addon \
              --cluster-name ${CLUSTER_NAME} \
              --addon-name amazon-cloudwatch-observability \
              --region ${AWS_REGION} || true

            eksctl delete iamserviceaccount \
              --cluster ${CLUSTER_NAME} \
              --region ${AWS_REGION} \
              --namespace amazon-cloudwatch \
              --name cloudwatch-agent || true

            # --------------------
            # Delete EKS cluster
            # --------------------
            eksctl delete cluster --name ${CLUSTER_NAME} --region ${AWS_REGION} || true

            # --------------------
            # CloudWatch log groups
            # --------------------
            aws logs describe-log-groups \
              --log-group-name-prefix /aws/containerinsights/${CLUSTER_NAME} \
              --region ${AWS_REGION} \
              --query 'logGroups[].logGroupName' \
              --output text | while read LOG_GROUP; do
                aws logs delete-log-group \
                  --log-group-name "$LOG_GROUP" \
                  --region ${AWS_REGION} || true
              done

            # --------------------
            # IAM policy cleanup
            # --------------------
            aws iam delete-policy \
              --policy-arn arn:aws:iam::$ACCOUNT_ID:policy/AWSLoadBalancerControllerIAMPolicyEC2 || true

            echo "EKS EC2 FULL destroy completed."
          '''
        }
      }
    }

    /* =======================
       EC2 DESTROY PATH
       ======================= */
    stage('Destroy EC2 Resources') {
      when { expression { params.DESTROY_TARGET == 'ec2' } }
      steps {
        sh 'echo "Destroying EC2-based deployment..."'
      }
    }
  }

  post {
    always {
      echo "Destroy pipeline completed."
      cleanWs(deleteDirs: true, disableDeferredWipeout: true)
    }
  }
}
